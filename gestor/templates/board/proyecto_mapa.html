<!-- templates/board/proyecto_mapa.html -->
{% extends "unfold/layouts/base.html" %}
{% load i18n static unfold %}

{% block title %}Mapa - {{ proyecto.nombre }}{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map {
            height: 600px;
            border-radius: 0.5rem;
            z-index: 1;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .leaflet-popup-content {
            margin: 1rem;
            font-family: inherit;
        }

        .elemento-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .elemento-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }

        .elemento-item.active {
            background-color: rgba(59, 130, 246, 0.2);
            border-left: 3px solid #3b82f6;
        }
    </style>
{% endblock %}

{% block content %}
    {{ block.super }}
    <div class="flex flex-col gap-6 p-6">
<div class="border border-base-300 border-dashed  p-3 rounded dark:border-base-700">
        {# Header #}
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold  text-base-900 dark:text-white">
                     Mapa del Proyecto
                </h1>
                <div class="flex items-center gap-2 mt-2 text-sm text-base-600 dark:text-base-400">
                    <span class="font-medium">{{ proyecto.codigo }}</span>
                    <span>â€¢</span>
                    <span>{{ proyecto.nombre }}</span>
                    <span>â€¢</span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-base-100 text-primary-800 dark:bg-base-900 dark:text-primary-200">
                        {{ elementos|length }} elementos
                    </span>
                </div>
            </div>
            <div class="flex gap-3">
                <a href="{% url 'admin:proyecto_dashboard' proyecto.id %}"
                   class="inline-flex items-center px-4 py-2 border border-base-300 dark:border-base-600
                          rounded-lg text-sm font-medium text-base-700 dark:text-base-200
                          bg-white dark:bg-base-800 hover:bg-base-50 dark:hover:bg-base-700">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Dashboard
                </a>
                <a href="{% url 'admin:gestor_proyecto_change' proyecto.id %}"
                   class="inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700
                          text-white rounded-lg text-sm font-medium">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Editar Proyecto
                </a>
            </div>
        </div>
</div>



        {# EstadÃ­sticas rÃ¡pidas #}
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <div class="bg-white dark:bg-base-800 rounded-lg shadow-sm border border-base-200 dark:border-base-700 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-base-500 dark:text-base-400 uppercase">Total</p>
                        <p class="text-2xl font-bold text-base-900 dark:text-white"
                           id="total-count">{{ elementos|length }}</p>
                    </div>
                    <div class="p-2 bg-base-100 dark:bg-base-900 rounded-lg">
                        <svg class="w-5 h-5 text-primary-600 dark:text-primary-400" fill="none" stroke="currentColor"
                             viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-base-800 rounded-lg shadow-sm border border-base-200 dark:border-base-700 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-base-500 dark:text-base-400 uppercase">Terminado</p>
                        <p class="text-2xl font-bold text-green-600 dark:text-green-400" id="terminado-count">0</p>
                    </div>
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                </div>
            </div>

            <div class="bg-white dark:bg-base-800 rounded-lg shadow-sm border border-base-200 dark:border-base-700 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-base-500 dark:text-base-400 uppercase">En Proceso</p>
                        <p class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" id="proceso-count">0</p>
                    </div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                </div>
            </div>

            <div class="bg-white dark:bg-base-800 rounded-lg shadow-sm border border-base-200 dark:border-base-700 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-base-500 dark:text-base-400 uppercase">Pendiente</p>
                        <p class="text-2xl font-bold text-red-600 dark:text-red-400" id="pendiente-count">0</p>
                    </div>
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                </div>
            </div>

            <div class="bg-white dark:bg-base-800 rounded-lg shadow-sm border border-base-200 dark:border-base-700 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-base-500 dark:text-base-400 uppercase">Benchmark</p>
                        <p class="text-2xl font-bold text-primary-600 dark:text-primary-400">1</p>
                    </div>
                    <div class="w-3 h-3 rounded-full bg-base-500"></div>
                </div>
            </div>
        </div>

        {# Contenedor principal con mapa y panel lateral #}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            {# Mapa #}
            <div class="lg:col-span-2">
                <div class="bg-white dark:bg-base-800 rounded-lg shadow-sm border border-base-200 dark:border-base-700 overflow-hidden">
                    {# Controles del mapa #}
                    <div class="p-4 border-b border-base-200 dark:border-base-700">
                        <div class="flex flex-wrap items-center gap-3">
                            <div class="flex-1 min-w-[200px]">
                                <input type="text"
                                       id="searchInput"
                                       placeholder="Buscar elemento por cÃ³digo o nombre..."
                                       class="w-full px-4 py-2 border border-base-300 dark:border-base-600 rounded-lg
                                              bg-white dark:bg-base-700 text-base-900 dark:text-white
                                              focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm">
                            </div>
                            <select id="filterEstado"
                                    class="px-4 py-2 border border-base-300 dark:border-base-600 rounded-lg
                                           bg-white dark:bg-base-700 text-base-900 dark:text-white text-sm">
                                <option value="">Todos los estados</option>
                                <option value="TERMINADO">Terminado</option>
                                <option value="COLADO">Colado</option>
                                <option value="ARMADO">Armado</option>
                                <option value="CIMBRADO">Cimbrado</option>
                                <option value="EXCAVACION">ExcavaciÃ³n</option>
                                <option value="REPLANTEO">Replanteo</option>
                                <option value="PENDIENTE">Pendiente</option>
                            </select>
                            <button id="btnCenterMap"
                                    class="px-4 py-2 bg-base-100 dark:bg-base-700 hover:bg-base-200 dark:hover:bg-base-600
                                           text-base-700 dark:text-base-200 rounded-lg text-sm font-medium">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    {# El mapa #}
                    <div id="map"></div>
                </div>
            </div>

            {# Panel lateral - Lista de elementos #}
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-base-800 rounded-lg shadow-sm border border-base-200 dark:border-base-700">
                    <div class="p-4 border-b border-base-200 dark:border-base-700">
                        <h3 class="text-lg font-semibold text-base-900 dark:text-white">
                            Elementos del Proyecto
                        </h3>
                        <p class="text-sm text-base-500 dark:text-base-400 mt-1">
                            Click para centrar en el mapa
                        </p>
                    </div>

                    <div id="elementosList" class="overflow-y-auto" style="max-height: 600px;">
                        {% for elemento in elementos %}
                            <div class="elemento-item p-4 border-b border-base-100 dark:border-base-700"
                                 data-id="{{ elemento.id }}"
                                 data-lat="{{ elemento.latitud }}"
                                 data-lng="{{ elemento.longitud }}"
                                 data-estado="{{ elemento.estado }}">
                                <div class="flex items-start gap-3">
                                    <div class="w-3 h-3 rounded-full mt-1 flex-shrink-0
                                    {% if elemento.estado == 'TERMINADO' or elemento.estado == 'COLADO' %}bg-green-500
                                    {% elif elemento.estado == 'ARMADO' or elemento.estado == 'CIMBRADO' or elemento.estado == 'EXCAVACION' %}bg-yellow-500
                                    {% else %}bg-red-500
                                    {% endif %}">
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-base-900 dark:text-white truncate">
                                            {{ elemento.codigo }}
                                        </p>
                                        <p class="text-xs text-base-500 dark:text-base-400 truncate">
                                            {{ elemento.nombre }}
                                        </p>
                                        <div class="flex items-center gap-2 mt-1">

                                            {% include 'unfold/helpers/label.html' with text=elemento.estado type=elemento.estado %}
                                            <span class="text-xs text-base-500 dark:text-base-400">
                                            {{ elemento.porcentaje_avance }}%
                                        </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="p-8 text-center text-base-500 dark:text-base-400">
                                No hay elementos en este proyecto
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div>

        {# Leyenda expandible #}
        <div class="bg-white dark:bg-base-800 rounded-lg shadow-sm border border-base-200 dark:border-base-700 p-6">
            <h3 class="text-lg font-semibold text-base-900 dark:text-white mb-4">Leyenda del Mapa</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4">
                <div class="flex items-center gap-2">
                    <div class="w-5 h-5 rounded-full bg-green-500 border-2 border-white dark:border-base-800 shadow"></div>
                    <span class="text-sm text-base-700 dark:text-base-300">Terminado / Colado</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-5 h-5 rounded-full bg-yellow-500 border-2 border-white dark:border-base-800 shadow"></div>
                    <span class="text-sm text-base-700 dark:text-base-300">Armado / Cimbrado</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-5 h-5 rounded-full bg-yellow-500 border-2 border-white dark:border-base-800 shadow"></div>
                    <span class="text-sm text-base-700 dark:text-base-300">ExcavaciÃ³n</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-5 h-5 rounded-full bg-red-500 border-2 border-white dark:border-base-800 shadow"></div>
                    <span class="text-sm text-base-700 dark:text-base-300">Replanteo / Pendiente</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-5 h-5 rounded-full bg-base-500 border-2 border-white dark:border-base-800 shadow"></div>
                    <span class="text-sm text-base-700 dark:text-base-300">Benchmark</span>
                </div>
            </div>
        </div>

    </div>
    {% block extrajs %}
        {{ block.super }}
        <script>
            // Variables globales
            let map;
            let markers = {};
            let allElementos = {{ elementos_json|safe }};

            // Inicializar mapa
            function initMap() {
                map = L.map('map').setView([{{ proyecto.lat_referencia }}, {{ proyecto.lon_referencia }}], 15);

                // Tile layer con mejor estilo
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                // Benchmark principal con estilo mejorado
                const benchmarkIcon = L.divIcon({
                    html: `<div style="background: #3b82f6; width: 32px; height: 32px; border-radius: 50%;
                       border: 3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                       display: flex; align-items: center; justify-content: center;">
                       <span style="color: white; font-size: 16px;">ðŸŽ¯</span>
                       </div>`,
                    className: '',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });

                L.marker([{{ proyecto.lat_referencia }}, {{ proyecto.lon_referencia }}], {icon: benchmarkIcon})
                    .addTo(map)
                    .bindPopup(`
                    <div style="min-width: 200px;">
                        <strong style="font-size: 14px; color: #1f2937;">ðŸŽ¯ Benchmark Principal</strong><br/>
                        <div style="margin-top: 8px; font-size: 13px; color: #6b7280;">
                            <strong>ElevaciÃ³n:</strong> {{ proyecto.elevacion_referencia }}m<br/>
                            <strong>Coordenadas:</strong><br/>
                            Lat: {{ proyecto.lat_referencia|floatformat:6 }}<br/>
                            Lng: {{ proyecto.lon_referencia|floatformat:6 }}
                        </div>
                    </div>
                `);

                // Agregar elementos
                addElementsToMap(allElementos);
                updateCounts();
            }

            // FunciÃ³n para obtener color segÃºn estado
            function getColor(estado) {
                const colors = {
                    'TERMINADO': '#10b981',
                    'COLADO': '#10b981',
                    'ARMADO': '#f59e0b',
                    'CIMBRADO': '#f59e0b',
                    'EXCAVACION': '#f59e0b',
                    'REPLANTEO': '#ef4444',
                    'PENDIENTE': '#ef4444'
                };
                return colors[estado] || '#64748b';
            }

            // Agregar elementos al mapa
            function addElementsToMap(elementos) {
                // Limpiar markers existentes
                Object.values(markers).forEach(marker => map.removeLayer(marker));
                markers = {};

                elementos.forEach(elemento => {
                    const color = getColor(elemento.estado);
                    const icon = L.divIcon({
                        html: `<div style="background: ${color}; width: 22px; height: 22px; border-radius: 50%;
                           border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                           transition: transform 0.2s;"
                           class="elemento-marker"></div>`,
                        className: '',
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    });

                    const marker = L.marker([elemento.latitud, elemento.longitud], {icon: icon})
                        .addTo(map)
                        .bindPopup(`
                        <div style="min-width: 250px;">
                            <strong style="font-size: 15px; color: #1f2937;">${elemento.codigo}</strong><br/>
                            <p style="margin: 4px 0; color: #6b7280; font-size: 13px;">${elemento.nombre}</p>
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="color: #6b7280; font-size: 12px;">Estado:</span>
                                    <span style="background: ${color}; color: white; padding: 2px 8px;
                                          border-radius: 4px; font-size: 11px; font-weight: 600;">
                                        ${elemento.estado_display}
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: #6b7280; font-size: 12px;">Avance:</span>
                                    <span style="font-weight: 600; font-size: 12px;">${elemento.porcentaje_avance}%</span>
                                </div>
                                <div style="width: 100%; background: #e5e7eb; border-radius: 999px; height: 6px; overflow: hidden;">
                                    <div style="width: ${elemento.porcentaje_avance}%; background: ${color}; height: 100%;"></div>
                                </div>
                            </div>
                            <a href="/gestor/elementoconstructivo/${elemento.id}/change/"
                               target="_blank"
                               style="display: inline-block; margin-top: 12px; padding: 6px 12px;
                                      background: #3b82f6; color: white; text-decoration: none;
                                      border-radius: 6px; font-size: 12px; font-weight: 500;">
                                Ver Detalles â†’
                            </a>
                        </div>
                    `);

                    markers[elemento.id] = marker;

                    // Efecto hover en marker
                    marker.on('mouseover', function () {
                        this._icon.querySelector('.elemento-marker').style.transform = 'scale(1.3)';
                    });
                    marker.on('mouseout', function () {
                        this._icon.querySelector('.elemento-marker').style.transform = 'scale(1)';
                    });
                });
            }

            // Actualizar contadores
            function updateCounts() {
                const terminado = allElementos.filter(e => e.estado === 'TERMINADO' || e.estado === 'COLADO').length;
                const proceso = allElementos.filter(e => ['ARMADO', 'CIMBRADO', 'EXCAVACION'].includes(e.estado)).length;
                const pendiente = allElementos.filter(e => e.estado === 'PENDIENTE' || e.estado === 'REPLANTEO').length;

                document.getElementById('terminado-count').textContent = terminado;
                document.getElementById('proceso-count').textContent = proceso;
                document.getElementById('pendiente-count').textContent = pendiente;
            }

            // Filtrar elementos
            function filterElements() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const estadoFilter = document.getElementById('filterEstado').value;

                const filtered = allElementos.filter(elemento => {
                    const matchSearch = elemento.codigo.toLowerCase().includes(searchTerm) ||
                        elemento.nombre.toLowerCase().includes(searchTerm);
                    const matchEstado = !estadoFilter || elemento.estado === estadoFilter;
                    return matchSearch && matchEstado;
                });

                addElementsToMap(filtered);

                // Actualizar lista lateral
                document.querySelectorAll('.elemento-item').forEach(item => {
                    const id = item.dataset.id;
                    const visible = filtered.some(e => e.id === id);
                    item.style.display = visible ? 'block' : 'none';
                });

                // Actualizar contador
                document.getElementById('total-count').textContent = filtered.length;
            }

            // Event listeners
            document.getElementById('searchInput').addEventListener('input', filterElements);
            document.getElementById('filterEstado').addEventListener('change', filterElements);

            // Centrar mapa en benchmark
            document.getElementById('btnCenterMap').addEventListener('click', function () {
                map.setView([{{ proyecto.lat_referencia }}, {{ proyecto.lon_referencia }}], 15);
            });

            // Click en elementos de la lista
            document.querySelectorAll('.elemento-item').forEach(item => {
                item.addEventListener('click', function () {
                    const lat = parseFloat(this.dataset.lat);
                    const lng = parseFloat(this.dataset.lng);
                    const id = this.dataset.id;

                    // Remover clase active de todos
                    document.querySelectorAll('.elemento-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');

                    // Centrar mapa y abrir popup
                    map.setView([lat, lng], 18);
                    if (markers[id]) {
                        markers[id].openPopup();
                    }
                });
            });

            // Inicializar al cargar
            document.addEventListener('DOMContentLoaded', initMap);
        </script>
    {% endblock %}
{% endblock %}

